# 从浏览器输入网址到页面渲染中间发生了什么？

这个问题还牵扯浏览器内核实现的相关知识，这里先不做拓展后续另开文章来写

## 第一步：处理输入

当我们在浏览器的地址栏输入内容按下回车时，浏览器（的 UI thread）会判断输入的内容是搜索关键词还是 URL，如果是搜索关键词，则跳转至默认搜索引擎对应的搜索 URL，如果输入的内容是 URL 则开始请求 URL。同时浏览器会进行 URL 解析，从最终的字符串，中获取协议、主机、端口、路径等等信息。URL 的一般格式为：

```
<scheme>://<user>:<password>@<host>:<port>/<path>;<params>?<query>#<flag>
```

## 第二步：域名 DNS 解析

将步骤一中获取的服务器域名解析为具体的 IP 地址，这就是 DNS 解析。DNS 解析具体分为以下几个步骤：

1. 先查看浏览器 DNS 缓存中是否有域名对应的 IP
2. 如果没有则查看操作系统 DNS 缓存中是否有对应的 IP
3. 若依旧没有就对本地区的 DNS 服务器发起请求
4. 如果依旧没有就直接访问 Root Server 域名服务器请求解析

## 第三步：通过 IP 寻址找到目标服务器地址

将步骤二中解析出的 IP 通过寻址找到 IP 对应的服务器，然后通过 arp 协议找到服务器的 mac 地址。

### IP 如何寻址？

IP 寻址会分同一网段寻址和不同网段寻址两种情况。

同一网段的情况：

主机 A 和主机 B，首先主机 A 通过本机的 hosts 表或者 wins 系统或 dns 系统先将主机 B 的计算机名 转换为 Ip 地址，然后用自己的 Ip 地址与子网掩码计算出自己所出的网段，比较目的主机 B 的 ip 地址与自己的子网掩码，发现与自己是出于相同的网段，于是在自己的 ARP 缓存中查找是否有主机 B 的 mac 地址，如果能找到就直接做数据链路层封装并且通过网卡将封装好的以太网帧发送有物理线路上去：如果 arp 缓存中没有主机 B 的的 mac 地址，主机 A 将启动 arp 协议通过在本地网络上的 arp 广播来查询主机 B 的 mac 地址，获得主机 B 的 mac 地址厚写入 arp 缓存表，进行数据链路层的封装，发送数据。

不同网段的情况：

不同的数据链路层网络必须分配不同网段的 Ip 地址并且由路由器将其连接起来。和上面一样，主机 A 发现和主机 B 不在同一个网段，于是主机 A 将知道应该将次数据包发送给自己的缺省网关，即路由器的本地接口。主机 A 在自己的 ARP 缓存中查找是否有缺省网关的 MAC 地址，如果能够找到就直接做数据链路层封装并通过网卡 将封装好的以太网数据帧发送到物理线路上去，如果 arp 缓存表中没有缺省网关的 Mac 地址，主机 A 将启动 arp 协议通过在本地网络上的 arp 广播来查询缺省网关的 mac 地址，获得缺省网关的 mac 地址后写入 arp 缓存表，进行数据链路层的封装，发送数据。数据帧到达路由器的接受接口后首先解封装，变成 ip 数据包，对 ip 包进行处理，根据目的 Ip 地址查找路由表，决定转发接口后做适应转发接口数据链路层协议帧的封装，并且发送到下一跳路由器，次过程继续直至到达目的的网络与目的主机。整个过程有点像 dns 解析，只是 dns 服务器换成了下一跳路由器，udp 编程了 tcp，其他差别不大。

### arp

arp 就是地址转化协议，也就是吧 IP 地址转化为 mac 地址。过程和 DNS 很像，先查缓存，然后查路由器

## 第四步：进行 TCP 三次握手，简历 TCP 连接

步骤三中我们找到了目标 ip，并获得了服务器 ip 的 mac 地址。此时浏览器就会请求和服务器连接，用来传输数据。tcp 是稳定双向面向连接的，断开时也会分两边分别断开。面向连接不是说 tcp 一个双方一直开着的通道，而是维持一个连接的状态，让它看起来有连接。

## 第五步：发送数据，等待服务器响应

第四步已经建立了连接，此时就要发送数据了。浏览器会对请求进行包装，包装成请求报文。请求报文的格式如下：
起始行：如 GET / HTTP/1.0 （请求的方法 请求的 URL 请求所使用的协议）
头部信息：User-Agent Host 等成对出现的值

主体

请求头部和主体之间有一个回车换行。如果是 get 请求，则没有主体部分，post 请求有主体部分。

## 第六步：服务器处理请求并作出响应

## 第七步：浏览器读取响应

浏览器（的 network thread）接受到服务器的响应后，开始解析 HTTP 响应报文，然后根据响应头中的 Content-Type 字段来确定响应主体的媒体类型（MIME Type），如果是一个 HTML 文件，则讲响应数据交给渲染进程（renderer process）来进行下一步的工作，如果是 zip 文件或者其他文件，会把相关数据传输给下载管理器。

同时浏览器会进行安全检查，如果域名或者请求的内容匹配到已知的恶意站点则会展示一个警告。

## 第八步：渲染页面

1. 构建 DOM
2. 子资源加载
3. JavaScript 下载与执行
4. 样式计算
5. 布局
6. 绘制
7. 合成
